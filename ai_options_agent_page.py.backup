"""
AI Options Agent Page
Streamlit UI for AI-powered options analysis and recommendations
"""

import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import time

# Import AI Options Agent components
from src.ai_options_agent.options_analysis_agent import OptionsAnalysisAgent
from src.ai_options_agent.ai_options_db_manager import AIOptionsDBManager


def display_score_gauge(score: int, label: str):
    """Display a score as a colored gauge"""
    if score >= 80:
        color = "üü¢"
    elif score >= 60:
        color = "üü°"
    else:
        color = "üî¥"

    st.metric(label, f"{score}/100 {color}")


def display_recommendation_badge(recommendation: str):
    """Display recommendation with color coding"""
    colors = {
        'STRONG_BUY': 'üü¢',
        'BUY': 'üü¢',
        'HOLD': 'üü°',
        'CAUTION': 'üü†',
        'AVOID': 'üî¥'
    }

    color = colors.get(recommendation, '‚ö™')
    return f"{color} {recommendation}"


def render_ai_options_agent_page():
    """Main UI for AI Options Agent"""

    st.title("ü§ñ AI Options Agent")
    st.markdown("""
    **AI-Powered Options Analysis** using Multi-Criteria Decision Making (MCDM) + LLM Reasoning
    """)

    # Initialize LLM manager first
    if 'llm_manager' not in st.session_state:
        from src.ai_options_agent.llm_manager import get_llm_manager
        st.session_state.llm_manager = get_llm_manager()

    # Initialize agent with LLM manager
    if 'ai_agent' not in st.session_state:
        with st.spinner("Initializing AI Options Agent..."):
            st.session_state.ai_agent = OptionsAnalysisAgent(
                llm_manager=st.session_state.llm_manager
            )
            st.session_state.db_manager = AIOptionsDBManager()

    agent = st.session_state.ai_agent
    db_manager = st.session_state.db_manager
    llm_manager = st.session_state.llm_manager

    # === LLM PROVIDER SECTION ===
    st.markdown("---")
    st.subheader("ü§ñ LLM Provider Configuration")

    # Get available providers
    available_providers = llm_manager.get_available_providers()

    col1, col2 = st.columns([2, 1])

    with col1:
        st.markdown("**Available Providers:**")

        if available_providers:
            # Create provider selection
            provider_options = {
                f"{p['name']} - {p['cost']} (Speed: {p['speed']})": p['id']
                for p in available_providers
            }
            provider_options["üîÑ Auto-select (Prioritizes Free/Cheap)"] = None

            selected_provider_display = st.selectbox(
                "Choose LLM Provider:",
                options=list(provider_options.keys()),
                index=0,
                help="Select which AI provider to use for reasoning"
            )

            selected_provider = provider_options[selected_provider_display]

            # Show provider details
            if selected_provider:
                provider_info = next((p for p in available_providers if p['id'] == selected_provider), None)
                if provider_info:
                    st.info(f"""
                    **{provider_info['name']}**
                    - Model: `{provider_info['current_model']}`
                    - Cost: {provider_info['cost']}
                    - Speed: {provider_info['speed']}
                    - Quality: {provider_info['quality']}
                    """)
        else:
            st.warning("‚ö†Ô∏è No LLM providers available. Add API keys below to enable LLM reasoning.")
            selected_provider = None

    with col2:
        st.markdown("**Provider Status:**")
        if available_providers:
            for p in available_providers[:3]:  # Show top 3
                st.success(f"‚úì {p['name']}")
        else:
            st.error("No providers configured")

    # === ADD NEW PROVIDER SECTION ===
    with st.expander("‚ûï Add New LLM Provider", expanded=False):
        st.markdown("Add a new AI provider by entering its API key:")

        col1, col2, col3 = st.columns([2, 2, 1])

        with col1:
            new_provider_type = st.selectbox(
                "Provider Type:",
                ["OpenAI", "Anthropic Claude", "Google Gemini", "DeepSeek", "Groq", "Grok (xAI)", "Kimi/Moonshot"],
                help="Select the type of provider you want to add"
            )

        with col2:
            new_api_key = st.text_input(
                "API Key:",
                type="password",
                placeholder="sk-...",
                help="Enter your API key for this provider"
            )

        with col3:
            st.markdown("<br>", unsafe_allow_html=True)
            test_provider = st.button("üß™ Test", use_container_width=True)

        if test_provider and new_api_key:
            # Map display name to env var name
            provider_map = {
                "OpenAI": "OPENAI_API_KEY",
                "Anthropic Claude": "ANTHROPIC_API_KEY",
                "Google Gemini": "GOOGLE_API_KEY",
                "DeepSeek": "DEEPSEEK_API_KEY",
                "Groq": "GROQ_API_KEY",
                "Grok (xAI)": "GROK_API_KEY",
                "Kimi/Moonshot": "KIMI_API_KEY"
            }

            env_var = provider_map.get(new_provider_type)

            with st.spinner(f"Testing {new_provider_type}..."):
                # Temporarily set the API key
                import os
                original_key = os.getenv(env_var)
                os.environ[env_var] = new_api_key

                try:
                    # Reload LLM manager with new key
                    from src.ai_options_agent.llm_manager import LLMManager
                    test_manager = LLMManager()

                    # Try to generate with this provider
                    provider_id = new_provider_type.lower().split()[0]
                    result = test_manager.generate(
                        "Say 'test successful' if you can read this.",
                        provider_id=provider_id,
                        max_tokens=50
                    )

                    if result['text'] and len(result['text']) > 0:
                        st.success(f"‚úÖ {new_provider_type} is working! API key is valid.")
                        st.info(f"Add this to your .env file:\n```\n{env_var}={new_api_key}\n```")

                        # Show test response
                        with st.expander("Test Response"):
                            st.write(result['text'])
                    else:
                        st.error(f"‚ùå Test failed - No response from {new_provider_type}")

                except Exception as e:
                    st.error(f"‚ùå Test failed: {str(e)}")

                finally:
                    # Restore original key
                    if original_key:
                        os.environ[env_var] = original_key
                    else:
                        os.environ.pop(env_var, None)

    # === ANALYSIS SETTINGS ===
    st.markdown("---")
    st.subheader("‚öôÔ∏è Analysis Settings")

    col1, col2, col3 = st.columns(3)

    with col1:
        # Analysis source
        analysis_source = st.radio(
            "Analyze:",
            ["All Stocks", "TradingView Watchlist"],
            help="Choose whether to analyze all stocks or a specific watchlist"
        )

        # Watchlist selection
        watchlist_name = None
        if analysis_source == "TradingView Watchlist":
            watchlists = db_manager.get_all_watchlists()
            if watchlists:
                watchlist_options = [w['name'] for w in watchlists]
                watchlist_name = st.selectbox(
                    "Select Watchlist:",
                    watchlist_options,
                    help="Choose a TradingView watchlist to analyze"
                )
            else:
                st.warning("No watchlists found. Please sync TradingView watchlists first.")

    with col2:
        # DTE Range
        st.markdown("**Days to Expiration (DTE)**")
        min_dte = st.number_input("Min DTE", 1, 90, 20, 1)
        max_dte = st.number_input("Max DTE", 1, 90, 40, 1)

        # Min Premium
        min_premium = st.number_input("Min Premium ($)", 0.0, 1000.0, 100.0, 10.0)

    with col3:
        # Delta Range
        st.markdown("**Delta Range (for puts)**")
        min_delta = st.number_input("Min Delta", -0.50, -0.01, -0.45, 0.01)
        max_delta = st.number_input("Max Delta", -0.50, -0.01, -0.15, 0.01)

        # Max Results
        max_results = st.number_input("Max Results", 10, 1000, 200, 50,
                                     help="Maximum number of opportunities to analyze (default: 200, max: 1000)")

    # Display Filters
    st.markdown("**Display Filters**")
    col1, col2 = st.columns(2)
    with col1:
        min_score_display = st.slider("Min Score to Display", 0, 100, 50, 5,
                                      help="Only show results with score above this threshold")
    with col2:
        use_llm_reasoning = st.checkbox("ü§ñ Use LLM Reasoning", value=False,
                                       help="Add AI-generated reasoning (slower, uses API)")

    # Run Analysis button
    st.markdown("---")
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        run_analysis = st.button("üöÄ Run Analysis", type="primary", use_container_width=True)

    # Main content area
    tab1, tab2, tab3 = st.tabs(["üìä Analysis Results", "üèÜ Top Picks", "üìà Performance"])

    # Tab 1: Analysis Results
    with tab1:
        # Load cached analyses on page load (if not running new analysis)
        if 'current_analyses' not in st.session_state and not run_analysis:
            # Try to load recent analyses from database
            cached_analyses = agent.get_top_recommendations(days=1, min_score=min_score_display)
            if cached_analyses:
                st.session_state.current_analyses = cached_analyses
                st.info(f"üìÇ Loaded {len(cached_analyses)} cached analyses from database (last 24 hours)")

        if run_analysis:
            with st.spinner("ü§ñ AI Agent is analyzing opportunities..."):
                start_time = time.time()

                # Run analysis based on source
                if analysis_source == "TradingView Watchlist" and watchlist_name:
                    analyses = agent.analyze_watchlist(
                        watchlist_name=watchlist_name,
                        dte_range=(min_dte, max_dte),
                        delta_range=(min_delta, max_delta),
                        min_premium=min_premium,
                        limit=max_results,
                        use_llm=use_llm_reasoning,
                        llm_provider=selected_provider
                    )
                else:
                    analyses = agent.analyze_all_stocks(
                        dte_range=(min_dte, max_dte),
                        delta_range=(min_delta, max_delta),
                        min_premium=min_premium,
                        limit=max_results,
                        use_llm=use_llm_reasoning,
                        llm_provider=selected_provider
                    )

                elapsed_time = time.time() - start_time

                # Filter by min score
                analyses = [a for a in analyses if a['final_score'] >= min_score_display]

                # Store in session state
                st.session_state.current_analyses = analyses
                st.session_state.analysis_time = elapsed_time

            st.success(f"‚úÖ Analysis complete! Analyzed {len(analyses)} opportunities in {elapsed_time:.1f}s")

        # Display results
        if 'current_analyses' in st.session_state and st.session_state.current_analyses:
            analyses = st.session_state.current_analyses

            st.subheader(f"üìä Found {len(analyses)} Opportunities")

            # Summary metrics
            col1, col2, col3, col4 = st.columns(4)

            strong_buys = len([a for a in analyses if a['recommendation'] == 'STRONG_BUY'])
            buys = len([a for a in analyses if a['recommendation'] == 'BUY'])
            avg_score = sum(a['final_score'] for a in analyses) / len(analyses)

            col1.metric("STRONG BUY", strong_buys)
            col2.metric("BUY", buys)
            col3.metric("Average Score", f"{avg_score:.0f}/100")
            col4.metric("Total Analyzed", len(analyses))

            st.markdown("---")

            # Display each analysis
            for analysis in analyses:
                with st.expander(
                    f"{analysis['symbol']} - {display_recommendation_badge(analysis['recommendation'])} - Score: {analysis['final_score']}/100",
                    expanded=analysis.get('recommendation') in ['STRONG_BUY', 'BUY']
                ):
                    # Key Info
                    col1, col2, col3, col4 = st.columns(4)
                    col1.metric("Strike", f"${analysis.get('strike_price', 0):.2f}")
                    col2.metric("DTE", analysis.get('dte', 'N/A'))
                    col3.metric("Premium", f"${analysis.get('premium', 0)/100:.2f}")
                    col4.metric("Monthly Return", f"{analysis.get('monthly_return', 0):.2f}%")

                    # Scores breakdown
                    st.markdown("**Score Breakdown:**")
                    score_cols = st.columns(5)
                    score_cols[0].metric("üìä Fundamental", f"{analysis['fundamental_score']}")
                    score_cols[1].metric("üìà Technical", f"{analysis['technical_score']}")
                    score_cols[2].metric("üéØ Greeks", f"{analysis['greeks_score']}")
                    score_cols[3].metric("‚ö†Ô∏è Risk", f"{analysis['risk_score']}")
                    score_cols[4].metric("üí≠ Sentiment", f"{analysis['sentiment_score']}")

                    # Strategy & Confidence
                    st.markdown(f"**Strategy:** {analysis.get('strategy', 'N/A')}")
                    st.markdown(f"**Confidence:** {analysis.get('confidence', 0)}%")

                    # LLM Model Info
                    llm_model = analysis.get('llm_model', 'rule_based_v1')
                    if llm_model != 'rule_based_v1':
                        st.markdown(f"**ü§ñ AI Model:** `{llm_model}` ({analysis.get('llm_tokens_used', 0)} tokens)")

                    # Reasoning
                    st.markdown("**Analysis:**")
                    st.info(analysis.get('reasoning', 'No reasoning available'))

                    # Risks and Opportunities
                    col1, col2 = st.columns(2)
                    with col1:
                        st.markdown("**‚ö†Ô∏è Key Risks:**")
                        st.warning(analysis.get('key_risks', 'None identified'))
                    with col2:
                        st.markdown("**‚ú® Key Opportunities:**")
                        st.success(analysis.get('key_opportunities', 'None identified'))

                    # Greeks detail
                    with st.expander("üìä Detailed Greeks"):
                        delta = analysis.get('delta')
                        iv = analysis.get('iv')

                        detail_cols = st.columns(3)
                        detail_cols[0].metric("Delta", f"{delta:.3f}" if delta else "N/A")
                        detail_cols[1].metric("IV", f"{iv*100:.1f}%" if iv else "N/A")
                        detail_cols[2].metric("Annual Return", f"{analysis.get('annual_return', 0):.1f}%")
        else:
            st.info("üëà Configure settings in the sidebar and click 'Run Analysis' to begin")

    # Tab 2: Top Picks
    with tab2:
        st.subheader("üèÜ Top AI-Recommended Picks")

        # Filters for top picks
        lookback_days = st.selectbox("Lookback Period", [1, 3, 7, 14, 30], index=2)

        top_picks = agent.get_top_recommendations(days=lookback_days, min_score=75)

        if top_picks:
            # Create DataFrame
            df_data = []
            for pick in top_picks[:20]:  # Show top 20
                df_data.append({
                    'Symbol': pick.get('symbol'),
                    'Score': pick.get('final_score'),
                    'Recommendation': pick.get('recommendation'),
                    'Strike': f"${pick.get('strike_price', 0):.2f}",
                    'DTE': pick.get('dte'),
                    'Premium': f"${pick.get('premium', 0)/100:.2f}",
                    'Monthly %': f"{pick.get('monthly_return', 0):.2f}%",
                    'Annual %': f"{pick.get('annual_return', 0):.1f}%",
                    'Confidence': f"{pick.get('confidence', 0)}%",
                    'Strategy': pick.get('strategy', 'CSP')
                })

            df = pd.DataFrame(df_data)

            # Style the dataframe
            st.dataframe(
                df,
                use_container_width=True,
                hide_index=True
            )

            # Download button
            csv = df.to_csv(index=False)
            st.download_button(
                label="üì• Download as CSV",
                data=csv,
                file_name=f"ai_options_picks_{datetime.now().strftime('%Y%m%d')}.csv",
                mime="text/csv"
            )
        else:
            st.info(f"No recommendations found in the last {lookback_days} days. Run an analysis to generate recommendations.")

    # Tab 3: Performance Tracking
    with tab3:
        st.subheader("üìà AI Agent Performance")
        st.markdown("""
        **Coming Soon:**
        - Accuracy tracking (predicted vs actual outcomes)
        - Win rate by score threshold
        - Average P&L by recommendation type
        - Agent learning and improvement metrics

        *Performance tracking will be enabled after you start executing trades based on AI recommendations.*
        """)

        # Show agent performance if available
        all_agents_perf = db_manager.get_all_agents_performance()
        if all_agents_perf:
            st.markdown("**Current Agent Performance:**")
            perf_data = []
            for agent_perf in all_agents_perf:
                perf_data.append({
                    'Agent': agent_perf.get('agent_name'),
                    'Total Predictions': agent_perf.get('total_predictions', 0),
                    'Correct': agent_perf.get('total_correct', 0),
                    'Accuracy': f"{agent_perf.get('avg_accuracy_rate', 0):.1f}%"
                })

            if perf_data:
                st.dataframe(pd.DataFrame(perf_data), use_container_width=True, hide_index=True)
        else:
            st.info("No performance data yet. Performance tracking begins after trade outcomes are recorded.")


# Run the page
if __name__ == "__main__":
    render_ai_options_agent_page()
